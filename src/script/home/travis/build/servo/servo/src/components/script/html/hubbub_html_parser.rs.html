<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="The script library documentation.">

    <title>hubbub_html_parser.rs.html -- source</title>

    <link href='http://fonts.googleapis.com/css?family=Source+Code+Pro:400,600'
          rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="../../../../../../../../../../../main.css">

    
</head>
<body>
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    <section class="sidebar">
        
        
    </section>

    <nav class="sub">
        <form class="search-form js-only">
            <div class="search-container">
                <input class="search-input" name="search"
                       autocomplete="off"
                       placeholder="Search documentation..."
                       type="search">
            </div>
        </form>
    </nav>

    <section id='main' class="content source"><pre class='line-numbers'><span id='1'>  1</span>
<span id='2'>  2</span>
<span id='3'>  3</span>
<span id='4'>  4</span>
<span id='5'>  5</span>
<span id='6'>  6</span>
<span id='7'>  7</span>
<span id='8'>  8</span>
<span id='9'>  9</span>
<span id='10'> 10</span>
<span id='11'> 11</span>
<span id='12'> 12</span>
<span id='13'> 13</span>
<span id='14'> 14</span>
<span id='15'> 15</span>
<span id='16'> 16</span>
<span id='17'> 17</span>
<span id='18'> 18</span>
<span id='19'> 19</span>
<span id='20'> 20</span>
<span id='21'> 21</span>
<span id='22'> 22</span>
<span id='23'> 23</span>
<span id='24'> 24</span>
<span id='25'> 25</span>
<span id='26'> 26</span>
<span id='27'> 27</span>
<span id='28'> 28</span>
<span id='29'> 29</span>
<span id='30'> 30</span>
<span id='31'> 31</span>
<span id='32'> 32</span>
<span id='33'> 33</span>
<span id='34'> 34</span>
<span id='35'> 35</span>
<span id='36'> 36</span>
<span id='37'> 37</span>
<span id='38'> 38</span>
<span id='39'> 39</span>
<span id='40'> 40</span>
<span id='41'> 41</span>
<span id='42'> 42</span>
<span id='43'> 43</span>
<span id='44'> 44</span>
<span id='45'> 45</span>
<span id='46'> 46</span>
<span id='47'> 47</span>
<span id='48'> 48</span>
<span id='49'> 49</span>
<span id='50'> 50</span>
<span id='51'> 51</span>
<span id='52'> 52</span>
<span id='53'> 53</span>
<span id='54'> 54</span>
<span id='55'> 55</span>
<span id='56'> 56</span>
<span id='57'> 57</span>
<span id='58'> 58</span>
<span id='59'> 59</span>
<span id='60'> 60</span>
<span id='61'> 61</span>
<span id='62'> 62</span>
<span id='63'> 63</span>
<span id='64'> 64</span>
<span id='65'> 65</span>
<span id='66'> 66</span>
<span id='67'> 67</span>
<span id='68'> 68</span>
<span id='69'> 69</span>
<span id='70'> 70</span>
<span id='71'> 71</span>
<span id='72'> 72</span>
<span id='73'> 73</span>
<span id='74'> 74</span>
<span id='75'> 75</span>
<span id='76'> 76</span>
<span id='77'> 77</span>
<span id='78'> 78</span>
<span id='79'> 79</span>
<span id='80'> 80</span>
<span id='81'> 81</span>
<span id='82'> 82</span>
<span id='83'> 83</span>
<span id='84'> 84</span>
<span id='85'> 85</span>
<span id='86'> 86</span>
<span id='87'> 87</span>
<span id='88'> 88</span>
<span id='89'> 89</span>
<span id='90'> 90</span>
<span id='91'> 91</span>
<span id='92'> 92</span>
<span id='93'> 93</span>
<span id='94'> 94</span>
<span id='95'> 95</span>
<span id='96'> 96</span>
<span id='97'> 97</span>
<span id='98'> 98</span>
<span id='99'> 99</span>
<span id='100'>100</span>
<span id='101'>101</span>
<span id='102'>102</span>
<span id='103'>103</span>
<span id='104'>104</span>
<span id='105'>105</span>
<span id='106'>106</span>
<span id='107'>107</span>
<span id='108'>108</span>
<span id='109'>109</span>
<span id='110'>110</span>
<span id='111'>111</span>
<span id='112'>112</span>
<span id='113'>113</span>
<span id='114'>114</span>
<span id='115'>115</span>
<span id='116'>116</span>
<span id='117'>117</span>
<span id='118'>118</span>
<span id='119'>119</span>
<span id='120'>120</span>
<span id='121'>121</span>
<span id='122'>122</span>
<span id='123'>123</span>
<span id='124'>124</span>
<span id='125'>125</span>
<span id='126'>126</span>
<span id='127'>127</span>
<span id='128'>128</span>
<span id='129'>129</span>
<span id='130'>130</span>
<span id='131'>131</span>
<span id='132'>132</span>
<span id='133'>133</span>
<span id='134'>134</span>
<span id='135'>135</span>
<span id='136'>136</span>
<span id='137'>137</span>
<span id='138'>138</span>
<span id='139'>139</span>
<span id='140'>140</span>
<span id='141'>141</span>
<span id='142'>142</span>
<span id='143'>143</span>
<span id='144'>144</span>
<span id='145'>145</span>
<span id='146'>146</span>
<span id='147'>147</span>
<span id='148'>148</span>
<span id='149'>149</span>
<span id='150'>150</span>
<span id='151'>151</span>
<span id='152'>152</span>
<span id='153'>153</span>
<span id='154'>154</span>
<span id='155'>155</span>
<span id='156'>156</span>
<span id='157'>157</span>
<span id='158'>158</span>
<span id='159'>159</span>
<span id='160'>160</span>
<span id='161'>161</span>
<span id='162'>162</span>
<span id='163'>163</span>
<span id='164'>164</span>
<span id='165'>165</span>
<span id='166'>166</span>
<span id='167'>167</span>
<span id='168'>168</span>
<span id='169'>169</span>
<span id='170'>170</span>
<span id='171'>171</span>
<span id='172'>172</span>
<span id='173'>173</span>
<span id='174'>174</span>
<span id='175'>175</span>
<span id='176'>176</span>
<span id='177'>177</span>
<span id='178'>178</span>
<span id='179'>179</span>
<span id='180'>180</span>
<span id='181'>181</span>
<span id='182'>182</span>
<span id='183'>183</span>
<span id='184'>184</span>
<span id='185'>185</span>
<span id='186'>186</span>
<span id='187'>187</span>
<span id='188'>188</span>
<span id='189'>189</span>
<span id='190'>190</span>
<span id='191'>191</span>
<span id='192'>192</span>
<span id='193'>193</span>
<span id='194'>194</span>
<span id='195'>195</span>
<span id='196'>196</span>
<span id='197'>197</span>
<span id='198'>198</span>
<span id='199'>199</span>
<span id='200'>200</span>
<span id='201'>201</span>
<span id='202'>202</span>
<span id='203'>203</span>
<span id='204'>204</span>
<span id='205'>205</span>
<span id='206'>206</span>
<span id='207'>207</span>
<span id='208'>208</span>
<span id='209'>209</span>
<span id='210'>210</span>
<span id='211'>211</span>
<span id='212'>212</span>
<span id='213'>213</span>
<span id='214'>214</span>
<span id='215'>215</span>
<span id='216'>216</span>
<span id='217'>217</span>
<span id='218'>218</span>
<span id='219'>219</span>
<span id='220'>220</span>
<span id='221'>221</span>
<span id='222'>222</span>
<span id='223'>223</span>
<span id='224'>224</span>
<span id='225'>225</span>
<span id='226'>226</span>
<span id='227'>227</span>
<span id='228'>228</span>
<span id='229'>229</span>
<span id='230'>230</span>
<span id='231'>231</span>
<span id='232'>232</span>
<span id='233'>233</span>
<span id='234'>234</span>
<span id='235'>235</span>
<span id='236'>236</span>
<span id='237'>237</span>
<span id='238'>238</span>
<span id='239'>239</span>
<span id='240'>240</span>
<span id='241'>241</span>
<span id='242'>242</span>
<span id='243'>243</span>
<span id='244'>244</span>
<span id='245'>245</span>
<span id='246'>246</span>
<span id='247'>247</span>
<span id='248'>248</span>
<span id='249'>249</span>
<span id='250'>250</span>
<span id='251'>251</span>
<span id='252'>252</span>
<span id='253'>253</span>
<span id='254'>254</span>
<span id='255'>255</span>
<span id='256'>256</span>
<span id='257'>257</span>
<span id='258'>258</span>
<span id='259'>259</span>
<span id='260'>260</span>
<span id='261'>261</span>
<span id='262'>262</span>
<span id='263'>263</span>
<span id='264'>264</span>
<span id='265'>265</span>
<span id='266'>266</span>
<span id='267'>267</span>
<span id='268'>268</span>
<span id='269'>269</span>
<span id='270'>270</span>
<span id='271'>271</span>
<span id='272'>272</span>
<span id='273'>273</span>
<span id='274'>274</span>
<span id='275'>275</span>
<span id='276'>276</span>
<span id='277'>277</span>
<span id='278'>278</span>
<span id='279'>279</span>
<span id='280'>280</span>
<span id='281'>281</span>
<span id='282'>282</span>
<span id='283'>283</span>
<span id='284'>284</span>
<span id='285'>285</span>
<span id='286'>286</span>
<span id='287'>287</span>
<span id='288'>288</span>
<span id='289'>289</span>
<span id='290'>290</span>
<span id='291'>291</span>
<span id='292'>292</span>
<span id='293'>293</span>
<span id='294'>294</span>
<span id='295'>295</span>
<span id='296'>296</span>
<span id='297'>297</span>
<span id='298'>298</span>
<span id='299'>299</span>
<span id='300'>300</span>
<span id='301'>301</span>
<span id='302'>302</span>
<span id='303'>303</span>
<span id='304'>304</span>
<span id='305'>305</span>
<span id='306'>306</span>
<span id='307'>307</span>
<span id='308'>308</span>
<span id='309'>309</span>
<span id='310'>310</span>
<span id='311'>311</span>
<span id='312'>312</span>
<span id='313'>313</span>
<span id='314'>314</span>
<span id='315'>315</span>
<span id='316'>316</span>
<span id='317'>317</span>
<span id='318'>318</span>
<span id='319'>319</span>
<span id='320'>320</span>
<span id='321'>321</span>
<span id='322'>322</span>
<span id='323'>323</span>
<span id='324'>324</span>
<span id='325'>325</span>
<span id='326'>326</span>
<span id='327'>327</span>
<span id='328'>328</span>
<span id='329'>329</span>
<span id='330'>330</span>
<span id='331'>331</span>
<span id='332'>332</span>
<span id='333'>333</span>
<span id='334'>334</span>
<span id='335'>335</span>
<span id='336'>336</span>
<span id='337'>337</span>
<span id='338'>338</span>
<span id='339'>339</span>
<span id='340'>340</span>
<span id='341'>341</span>
<span id='342'>342</span>
<span id='343'>343</span>
<span id='344'>344</span>
<span id='345'>345</span>
<span id='346'>346</span>
<span id='347'>347</span>
<span id='348'>348</span>
<span id='349'>349</span>
<span id='350'>350</span>
<span id='351'>351</span>
<span id='352'>352</span>
<span id='353'>353</span>
<span id='354'>354</span>
<span id='355'>355</span>
<span id='356'>356</span>
<span id='357'>357</span>
<span id='358'>358</span>
<span id='359'>359</span>
<span id='360'>360</span>
<span id='361'>361</span>
<span id='362'>362</span>
<span id='363'>363</span>
<span id='364'>364</span>
<span id='365'>365</span>
<span id='366'>366</span>
<span id='367'>367</span>
<span id='368'>368</span>
<span id='369'>369</span>
<span id='370'>370</span>
<span id='371'>371</span>
<span id='372'>372</span>
<span id='373'>373</span>
<span id='374'>374</span>
<span id='375'>375</span>
<span id='376'>376</span>
<span id='377'>377</span>
<span id='378'>378</span>
<span id='379'>379</span>
<span id='380'>380</span>
<span id='381'>381</span>
<span id='382'>382</span>
<span id='383'>383</span>
<span id='384'>384</span>
<span id='385'>385</span>
<span id='386'>386</span>
<span id='387'>387</span>
<span id='388'>388</span>
<span id='389'>389</span>
<span id='390'>390</span>
<span id='391'>391</span>
<span id='392'>392</span>
<span id='393'>393</span>
<span id='394'>394</span>
<span id='395'>395</span>
<span id='396'>396</span>
<span id='397'>397</span>
<span id='398'>398</span>
<span id='399'>399</span>
<span id='400'>400</span>
<span id='401'>401</span>
<span id='402'>402</span>
<span id='403'>403</span>
<span id='404'>404</span>
<span id='405'>405</span>
<span id='406'>406</span>
<span id='407'>407</span>
<span id='408'>408</span>
<span id='409'>409</span>
<span id='410'>410</span>
<span id='411'>411</span>
<span id='412'>412</span>
<span id='413'>413</span>
<span id='414'>414</span>
<span id='415'>415</span>
<span id='416'>416</span>
<span id='417'>417</span>
<span id='418'>418</span>
<span id='419'>419</span>
<span id='420'>420</span>
<span id='421'>421</span>
<span id='422'>422</span>
<span id='423'>423</span>
<span id='424'>424</span>
<span id='425'>425</span>
<span id='426'>426</span>
<span id='427'>427</span>
<span id='428'>428</span>
<span id='429'>429</span>
<span id='430'>430</span>
<span id='431'>431</span>
<span id='432'>432</span>
<span id='433'>433</span>
<span id='434'>434</span>
<span id='435'>435</span>
<span id='436'>436</span>
<span id='437'>437</span>
<span id='438'>438</span>
<span id='439'>439</span>
<span id='440'>440</span>
<span id='441'>441</span>
<span id='442'>442</span>
<span id='443'>443</span>
<span id='444'>444</span>
<span id='445'>445</span>
<span id='446'>446</span>
<span id='447'>447</span>
<span id='448'>448</span>
<span id='449'>449</span>
<span id='450'>450</span>
<span id='451'>451</span>
<span id='452'>452</span>
<span id='453'>453</span>
<span id='454'>454</span>
<span id='455'>455</span>
<span id='456'>456</span>
<span id='457'>457</span>
<span id='458'>458</span>
<span id='459'>459</span>
<span id='460'>460</span>
<span id='461'>461</span>
<span id='462'>462</span>
<span id='463'>463</span>
<span id='464'>464</span>
<span id='465'>465</span>
<span id='466'>466</span>
<span id='467'>467</span>
<span id='468'>468</span>
<span id='469'>469</span>
<span id='470'>470</span>
<span id='471'>471</span>
<span id='472'>472</span>
<span id='473'>473</span>
<span id='474'>474</span>
<span id='475'>475</span>
<span id='476'>476</span>
<span id='477'>477</span>
<span id='478'>478</span>
<span id='479'>479</span>
<span id='480'>480</span>
<span id='481'>481</span>
<span id='482'>482</span>
<span id='483'>483</span>
<span id='484'>484</span>
<span id='485'>485</span>
<span id='486'>486</span>
<span id='487'>487</span>
<span id='488'>488</span>
<span id='489'>489</span>
<span id='490'>490</span>
<span id='491'>491</span>
<span id='492'>492</span>
<span id='493'>493</span>
<span id='494'>494</span>
<span id='495'>495</span>
<span id='496'>496</span>
<span id='497'>497</span>
<span id='498'>498</span>
<span id='499'>499</span>
<span id='500'>500</span>
<span id='501'>501</span>
<span id='502'>502</span>
<span id='503'>503</span>
<span id='504'>504</span>
<span id='505'>505</span>
<span id='506'>506</span>
<span id='507'>507</span>
<span id='508'>508</span>
<span id='509'>509</span>
<span id='510'>510</span>
<span id='511'>511</span>
<span id='512'>512</span>
<span id='513'>513</span>
<span id='514'>514</span>
<span id='515'>515</span>
<span id='516'>516</span>
<span id='517'>517</span>
<span id='518'>518</span>
<span id='519'>519</span>
<span id='520'>520</span>
<span id='521'>521</span>
<span id='522'>522</span>
<span id='523'>523</span>
<span id='524'>524</span>
<span id='525'>525</span>
<span id='526'>526</span>
<span id='527'>527</span>
<span id='528'>528</span>
<span id='529'>529</span>
<span id='530'>530</span>
<span id='531'>531</span>
<span id='532'>532</span>
<span id='533'>533</span>
<span id='534'>534</span>
<span id='535'>535</span>
<span id='536'>536</span>
<span id='537'>537</span>
<span id='538'>538</span>
<span id='539'>539</span>
<span id='540'>540</span>
<span id='541'>541</span>
<span id='542'>542</span>
<span id='543'>543</span>
<span id='544'>544</span>
<span id='545'>545</span>
<span id='546'>546</span>
<span id='547'>547</span>
<span id='548'>548</span>
<span id='549'>549</span>
<span id='550'>550</span>
<span id='551'>551</span>
<span id='552'>552</span>
<span id='553'>553</span>
<span id='554'>554</span>
<span id='555'>555</span>
<span id='556'>556</span>
<span id='557'>557</span>
<span id='558'>558</span>
<span id='559'>559</span>
<span id='560'>560</span>
<span id='561'>561</span>
<span id='562'>562</span>
<span id='563'>563</span>
<span id='564'>564</span>
</pre><pre class='rust '>
<span class='comment'>/* This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at http://mozilla.org/MPL/2.0/. */

</span><span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>bindings</span>::<span class='ident'>codegen</span>::<span class='ident'>Bindings</span>::<span class='ident'>AttrBinding</span>::<span class='ident'>AttrMethods</span>;
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>bindings</span>::<span class='ident'>codegen</span>::<span class='ident'>Bindings</span>::<span class='ident'>NodeBinding</span>::<span class='ident'>NodeMethods</span>;
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>bindings</span>::<span class='ident'>codegen</span>::<span class='ident'>InheritTypes</span>::{<span class='ident'>NodeBase</span>, <span class='ident'>NodeCast</span>, <span class='ident'>TextCast</span>, <span class='ident'>ElementCast</span>};
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>bindings</span>::<span class='ident'>js</span>::{<span class='ident'>JS</span>, <span class='ident'>JSRef</span>, <span class='ident'>Temporary</span>, <span class='ident'>OptionalRootable</span>, <span class='ident'>Root</span>};
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>bindings</span>::<span class='ident'>utils</span>::<span class='ident'>Reflectable</span>;
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>document</span>::{<span class='ident'>Document</span>, <span class='ident'>DocumentHelpers</span>};
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>element</span>::{<span class='ident'>AttributeHandlers</span>, <span class='ident'>HTMLLinkElementTypeId</span>};
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>htmlelement</span>::<span class='ident'>HTMLElement</span>;
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>htmlheadingelement</span>::{<span class='ident'>Heading1</span>, <span class='ident'>Heading2</span>, <span class='ident'>Heading3</span>, <span class='ident'>Heading4</span>, <span class='ident'>Heading5</span>, <span class='ident'>Heading6</span>};
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>htmlformelement</span>::<span class='ident'>HTMLFormElement</span>;
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>node</span>::{<span class='ident'>ElementNodeTypeId</span>, <span class='ident'>NodeHelpers</span>};
<span class='kw'>use</span> <span class='ident'>dom</span>::<span class='ident'>types</span>::<span class='op'>*</span>;
<span class='kw'>use</span> <span class='ident'>html</span>::<span class='ident'>cssparse</span>::{<span class='ident'>StylesheetProvenance</span>, <span class='ident'>UrlProvenance</span>, <span class='ident'>spawn_css_parser</span>};
<span class='kw'>use</span> <span class='ident'>page</span>::<span class='ident'>Page</span>;

<span class='kw'>use</span> <span class='ident'>hubbub</span>::<span class='ident'>hubbub</span>;
<span class='kw'>use</span> <span class='ident'>hubbub</span>::<span class='ident'>hubbub</span>::{<span class='ident'>NullNs</span>, <span class='ident'>HtmlNs</span>, <span class='ident'>MathMlNs</span>, <span class='ident'>SvgNs</span>, <span class='ident'>XLinkNs</span>, <span class='ident'>XmlNs</span>, <span class='ident'>XmlNsNs</span>};
<span class='kw'>use</span> <span class='ident'>servo_net</span>::<span class='ident'>resource_task</span>::{<span class='ident'>Load</span>, <span class='ident'>LoadData</span>, <span class='ident'>Payload</span>, <span class='ident'>Done</span>, <span class='ident'>ResourceTask</span>, <span class='ident'>load_whole_resource</span>};
<span class='kw'>use</span> <span class='ident'>servo_util</span>::<span class='ident'>namespace</span>;
<span class='kw'>use</span> <span class='ident'>servo_util</span>::<span class='ident'>namespace</span>::{<span class='ident'>Namespace</span>, <span class='ident'>Null</span>};
<span class='kw'>use</span> <span class='ident'>servo_util</span>::<span class='ident'>str</span>::{<span class='ident'>DOMString</span>, <span class='ident'>HTML_SPACE_CHARACTERS</span>};
<span class='kw'>use</span> <span class='ident'>servo_util</span>::<span class='ident'>task</span>::<span class='ident'>spawn_named</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>ascii</span>::<span class='ident'>StrAsciiExt</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>mem</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>cell</span>::<span class='ident'>RefCell</span>;
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>comm</span>::{<span class='ident'>channel</span>, <span class='ident'>Sender</span>, <span class='ident'>Receiver</span>};
<span class='kw'>use</span> <span class='ident'>style</span>::<span class='ident'>Stylesheet</span>;
<span class='kw'>use</span> <span class='ident'>url</span>::{<span class='ident'>Url</span>, <span class='ident'>UrlParser</span>};

<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>handle_element</span>(
    (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>document</span>: <span class='ident'>expr</span>,
     <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>localName</span>: <span class='ident'>expr</span>,
     <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>string</span>: <span class='ident'>expr</span>,
     <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>ctor</span>: <span class='ident'>ident</span>
     $(, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>arg</span>:<span class='ident'>expr</span> )<span class='op'>*</span>) <span class='op'>=&gt;</span> (
        <span class='kw'>if</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>string</span> <span class='op'>==</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>localName</span>.<span class='ident'>as_slice</span>() {
            <span class='kw'>return</span> <span class='ident'>ElementCast</span>::<span class='ident'>from_temporary</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>ctor</span>::<span class='ident'>new</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>localName</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>document</span> $(, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>arg</span>)<span class='op'>*</span>));
        }
    )
)


<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>JSFile</span> {
    <span class='kw'>pub</span> <span class='ident'>data</span>: <span class='ident'>String</span>,
    <span class='kw'>pub</span> <span class='ident'>url</span>: <span class='ident'>Url</span>
}

<span class='kw'>pub</span> <span class='kw'>type</span> <span class='ident'>JSResult</span> <span class='op'>=</span> <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>JSFile</span><span class='op'>&gt;</span>;

<span class='kw'>enum</span> <span class='ident'>CSSMessage</span> {
    <span class='ident'>CSSTaskNewFile</span>(<span class='ident'>StylesheetProvenance</span>),
    <span class='ident'>CSSTaskExit</span>
}

<span class='kw'>enum</span> <span class='ident'>JSMessage</span> {
    <span class='ident'>JSTaskNewFile</span>(<span class='ident'>Url</span>),
    <span class='ident'>JSTaskNewInlineScript</span>(<span class='ident'>String</span>, <span class='ident'>Url</span>),
    <span class='ident'>JSTaskExit</span>
}

<span class='doccomment'>/// Messages generated by the HTML parser upon discovery of additional resources
</span><span class='kw'>pub</span> <span class='kw'>enum</span> <span class='ident'>HtmlDiscoveryMessage</span> {
    <span class='ident'>HtmlDiscoveredStyle</span>(<span class='ident'>Stylesheet</span>),
    <span class='ident'>HtmlDiscoveredScript</span>(<span class='ident'>JSResult</span>)
}

<span class='kw'>pub</span> <span class='kw'>struct</span> <span class='ident'>HtmlParserResult</span> {
    <span class='kw'>pub</span> <span class='ident'>discovery_port</span>: <span class='ident'>Receiver</span><span class='op'>&lt;</span><span class='ident'>HtmlDiscoveryMessage</span><span class='op'>&gt;</span>,
}

<span class='kw'>trait</span> <span class='ident'>NodeWrapping</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {
    <span class='kw'>unsafe</span> <span class='kw'>fn</span> <span class='ident'>to_hubbub_node</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>hubbub</span>::<span class='ident'>NodeDataPtr</span>;
}

<span class='kw'>impl</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span>, <span class='ident'>T</span>: <span class='ident'>NodeBase</span><span class='op'>+</span><span class='ident'>Reflectable</span><span class='op'>&gt;</span> <span class='ident'>NodeWrapping</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> <span class='kw'>for</span> <span class='ident'>JSRef</span><span class='op'>&lt;</span><span class='lifetime'>&#39;a</span>, <span class='ident'>T</span><span class='op'>&gt;</span> {
    <span class='kw'>unsafe</span> <span class='kw'>fn</span> <span class='ident'>to_hubbub_node</span>(<span class='kw-2'>&amp;</span><span class='self'>self</span>) <span class='op'>-&gt;</span> <span class='ident'>hubbub</span>::<span class='ident'>NodeDataPtr</span> {
        <span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='self'>self</span>.<span class='ident'>deref</span>())
    }
}

<span class='kw'>unsafe</span> <span class='kw'>fn</span> <span class='ident'>from_hubbub_node</span><span class='op'>&lt;</span><span class='ident'>T</span>: <span class='ident'>Reflectable</span><span class='op'>&gt;</span>(<span class='ident'>n</span>: <span class='ident'>hubbub</span>::<span class='ident'>NodeDataPtr</span>) <span class='op'>-&gt;</span> <span class='ident'>Temporary</span><span class='op'>&lt;</span><span class='ident'>T</span><span class='op'>&gt;</span> {
    <span class='ident'>Temporary</span>::<span class='ident'>new</span>(<span class='ident'>JS</span>::<span class='ident'>from_raw</span>(<span class='ident'>mem</span>::<span class='ident'>transmute</span>(<span class='ident'>n</span>)))
}

<span class='doccomment'>/**
Runs a task that coordinates parsing links to css stylesheets.

This function should be spawned in a separate task and spins waiting
for the html builder to find links to css stylesheets and sends off
tasks to parse each link.  When the html process finishes, it notifies
the listener, who then collects the css rules from each task it
spawned, collates them, and sends them to the given result channel.

# Arguments

* `to_parent` - A channel on which to send back the full set of rules.
* `from_parent` - A port on which to receive new links.

*/
</span><span class='kw'>fn</span> <span class='ident'>css_link_listener</span>(<span class='ident'>to_parent</span>: <span class='ident'>Sender</span><span class='op'>&lt;</span><span class='ident'>HtmlDiscoveryMessage</span><span class='op'>&gt;</span>,
                     <span class='ident'>from_parent</span>: <span class='ident'>Receiver</span><span class='op'>&lt;</span><span class='ident'>CSSMessage</span><span class='op'>&gt;</span>) {
    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>result_vec</span> <span class='op'>=</span> <span class='macro'>vec</span><span class='macro'>!</span>();

    <span class='kw'>loop</span> {
        <span class='kw'>match</span> <span class='ident'>from_parent</span>.<span class='ident'>recv_opt</span>() {
            <span class='prelude-val'>Ok</span>(<span class='ident'>CSSTaskNewFile</span>(<span class='ident'>provenance</span>)) <span class='op'>=&gt;</span> {
                <span class='ident'>result_vec</span>.<span class='ident'>push</span>(<span class='ident'>spawn_css_parser</span>(<span class='ident'>provenance</span>));
            }
            <span class='prelude-val'>Ok</span>(<span class='ident'>CSSTaskExit</span>) <span class='op'>|</span> <span class='prelude-val'>Err</span>(()) <span class='op'>=&gt;</span> {
                <span class='kw'>break</span>;
            }
        }
    }<span class='comment'>

    // Send the sheets back in order
    // FIXME: Shouldn&#39;t wait until after we&#39;ve recieved CSSTaskExit to start sending these
    </span><span class='kw'>for</span> <span class='ident'>port</span> <span class='kw'>in</span> <span class='ident'>result_vec</span>.<span class='ident'>iter</span>() {
        <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>to_parent</span>.<span class='ident'>send_opt</span>(<span class='ident'>HtmlDiscoveredStyle</span>(<span class='ident'>port</span>.<span class='ident'>recv</span>())).<span class='ident'>is_ok</span>());
    }
}

<span class='kw'>fn</span> <span class='ident'>js_script_listener</span>(<span class='ident'>to_parent</span>: <span class='ident'>Sender</span><span class='op'>&lt;</span><span class='ident'>HtmlDiscoveryMessage</span><span class='op'>&gt;</span>,
                      <span class='ident'>from_parent</span>: <span class='ident'>Receiver</span><span class='op'>&lt;</span><span class='ident'>JSMessage</span><span class='op'>&gt;</span>,
                      <span class='ident'>resource_task</span>: <span class='ident'>ResourceTask</span>) {
    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>result_vec</span> <span class='op'>=</span> <span class='macro'>vec</span><span class='macro'>!</span>();

    <span class='kw'>loop</span> {
        <span class='kw'>match</span> <span class='ident'>from_parent</span>.<span class='ident'>recv_opt</span>() {
            <span class='prelude-val'>Ok</span>(<span class='ident'>JSTaskNewFile</span>(<span class='ident'>url</span>)) <span class='op'>=&gt;</span> {
                <span class='kw'>match</span> <span class='ident'>load_whole_resource</span>(<span class='kw-2'>&amp;</span><span class='ident'>resource_task</span>, <span class='ident'>url</span>.<span class='ident'>clone</span>()) {
                    <span class='prelude-val'>Err</span>(_) <span class='op'>=&gt;</span> {
                        <span class='macro'>error</span><span class='macro'>!</span>(<span class='string'>&quot;error loading script {:s}&quot;</span>, <span class='ident'>url</span>.<span class='ident'>serialize</span>());
                    }
                    <span class='prelude-val'>Ok</span>((<span class='ident'>metadata</span>, <span class='ident'>bytes</span>)) <span class='op'>=&gt;</span> {
                        <span class='ident'>result_vec</span>.<span class='ident'>push</span>(<span class='ident'>JSFile</span> {
                            <span class='ident'>data</span>: <span class='ident'>String</span>::<span class='ident'>from_utf8</span>(<span class='ident'>bytes</span>).<span class='ident'>unwrap</span>().<span class='ident'>to_string</span>(),
                            <span class='ident'>url</span>: <span class='ident'>metadata</span>.<span class='ident'>final_url</span>,
                        });
                    }
                }
            }
            <span class='prelude-val'>Ok</span>(<span class='ident'>JSTaskNewInlineScript</span>(<span class='ident'>data</span>, <span class='ident'>url</span>)) <span class='op'>=&gt;</span> {
                <span class='ident'>result_vec</span>.<span class='ident'>push</span>(<span class='ident'>JSFile</span> { <span class='ident'>data</span>: <span class='ident'>data</span>, <span class='ident'>url</span>: <span class='ident'>url</span> });
            }
            <span class='prelude-val'>Ok</span>(<span class='ident'>JSTaskExit</span>) <span class='op'>|</span> <span class='prelude-val'>Err</span>(()) <span class='op'>=&gt;</span> {
                <span class='kw'>break</span>;
            }
        }
    }

    <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>to_parent</span>.<span class='ident'>send_opt</span>(<span class='ident'>HtmlDiscoveredScript</span>(<span class='ident'>result_vec</span>)).<span class='ident'>is_ok</span>());
}<span class='comment'>

// Silly macros to handle constructing      DOM nodes. This produces bad code and should be optimized
// via atomization (issue #85).

</span><span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>build_element_from_tag</span>(<span class='ident'>tag</span>: <span class='ident'>DOMString</span>, <span class='ident'>ns</span>: <span class='ident'>Namespace</span>, <span class='ident'>document</span>: <span class='kw-2'>&amp;</span><span class='ident'>JSRef</span><span class='op'>&lt;</span><span class='ident'>Document</span><span class='op'>&gt;</span>) <span class='op'>-&gt;</span> <span class='ident'>Temporary</span><span class='op'>&lt;</span><span class='ident'>Element</span><span class='op'>&gt;</span> {
    <span class='kw'>if</span> <span class='ident'>ns</span> <span class='op'>!=</span> <span class='ident'>namespace</span>::<span class='ident'>HTML</span> {
        <span class='kw'>return</span> <span class='ident'>Element</span>::<span class='ident'>new</span>(<span class='ident'>tag</span>, <span class='ident'>ns</span>, <span class='prelude-val'>None</span>, <span class='ident'>document</span>);
    }<span class='comment'>

    // TODO (Issue #85): use atoms
    </span><span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;a&quot;</span>,         <span class='ident'>HTMLAnchorElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;abbr&quot;</span>,      <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;acronym&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;address&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;applet&quot;</span>,    <span class='ident'>HTMLAppletElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;area&quot;</span>,      <span class='ident'>HTMLAreaElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;article&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;aside&quot;</span>,     <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;audio&quot;</span>,     <span class='ident'>HTMLAudioElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;b&quot;</span>,         <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;base&quot;</span>,      <span class='ident'>HTMLBaseElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;bdi&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;bdo&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;bgsound&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;big&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;blockquote&quot;</span>,<span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;body&quot;</span>,      <span class='ident'>HTMLBodyElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;br&quot;</span>,        <span class='ident'>HTMLBRElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;button&quot;</span>,    <span class='ident'>HTMLButtonElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;canvas&quot;</span>,    <span class='ident'>HTMLCanvasElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;caption&quot;</span>,   <span class='ident'>HTMLTableCaptionElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;center&quot;</span>,    <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;cite&quot;</span>,      <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;code&quot;</span>,      <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;col&quot;</span>,       <span class='ident'>HTMLTableColElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;colgroup&quot;</span>,  <span class='ident'>HTMLTableColElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;data&quot;</span>,      <span class='ident'>HTMLDataElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;datalist&quot;</span>,  <span class='ident'>HTMLDataListElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;dd&quot;</span>,        <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;del&quot;</span>,       <span class='ident'>HTMLModElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;details&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;dfn&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;dir&quot;</span>,       <span class='ident'>HTMLDirectoryElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;div&quot;</span>,       <span class='ident'>HTMLDivElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;dl&quot;</span>,        <span class='ident'>HTMLDListElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;dt&quot;</span>,        <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;em&quot;</span>,        <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;embed&quot;</span>,     <span class='ident'>HTMLEmbedElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;fieldset&quot;</span>,  <span class='ident'>HTMLFieldSetElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;figcaption&quot;</span>,<span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;figure&quot;</span>,    <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;font&quot;</span>,      <span class='ident'>HTMLFontElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;footer&quot;</span>,    <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;form&quot;</span>,      <span class='ident'>HTMLFormElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;frame&quot;</span>,     <span class='ident'>HTMLFrameElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;frameset&quot;</span>,  <span class='ident'>HTMLFrameSetElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;h1&quot;</span>,        <span class='ident'>HTMLHeadingElement</span>, <span class='ident'>Heading1</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;h2&quot;</span>,        <span class='ident'>HTMLHeadingElement</span>, <span class='ident'>Heading2</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;h3&quot;</span>,        <span class='ident'>HTMLHeadingElement</span>, <span class='ident'>Heading3</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;h4&quot;</span>,        <span class='ident'>HTMLHeadingElement</span>, <span class='ident'>Heading4</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;h5&quot;</span>,        <span class='ident'>HTMLHeadingElement</span>, <span class='ident'>Heading5</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;h6&quot;</span>,        <span class='ident'>HTMLHeadingElement</span>, <span class='ident'>Heading6</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;head&quot;</span>,      <span class='ident'>HTMLHeadElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;header&quot;</span>,    <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;hgroup&quot;</span>,    <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;hr&quot;</span>,        <span class='ident'>HTMLHRElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;html&quot;</span>,      <span class='ident'>HTMLHtmlElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;i&quot;</span>,         <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;iframe&quot;</span>,    <span class='ident'>HTMLIFrameElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;img&quot;</span>,       <span class='ident'>HTMLImageElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;input&quot;</span>,     <span class='ident'>HTMLInputElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;ins&quot;</span>,       <span class='ident'>HTMLModElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;isindex&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;kbd&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;label&quot;</span>,     <span class='ident'>HTMLLabelElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;legend&quot;</span>,    <span class='ident'>HTMLLegendElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;li&quot;</span>,        <span class='ident'>HTMLLIElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;link&quot;</span>,      <span class='ident'>HTMLLinkElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;main&quot;</span>,      <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;map&quot;</span>,       <span class='ident'>HTMLMapElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;mark&quot;</span>,      <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;marquee&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;meta&quot;</span>,      <span class='ident'>HTMLMetaElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;meter&quot;</span>,     <span class='ident'>HTMLMeterElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;nav&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;nobr&quot;</span>,      <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;noframes&quot;</span>,  <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;noscript&quot;</span>,  <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;object&quot;</span>,    <span class='ident'>HTMLObjectElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;ol&quot;</span>,        <span class='ident'>HTMLOListElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;optgroup&quot;</span>,  <span class='ident'>HTMLOptGroupElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;option&quot;</span>,    <span class='ident'>HTMLOptionElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;output&quot;</span>,    <span class='ident'>HTMLOutputElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;p&quot;</span>,         <span class='ident'>HTMLParagraphElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;param&quot;</span>,     <span class='ident'>HTMLParamElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;pre&quot;</span>,       <span class='ident'>HTMLPreElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;progress&quot;</span>,  <span class='ident'>HTMLProgressElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;q&quot;</span>,         <span class='ident'>HTMLQuoteElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;rp&quot;</span>,        <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;rt&quot;</span>,        <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;ruby&quot;</span>,      <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;s&quot;</span>,         <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;samp&quot;</span>,      <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;script&quot;</span>,    <span class='ident'>HTMLScriptElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;section&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;select&quot;</span>,    <span class='ident'>HTMLSelectElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;small&quot;</span>,     <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;source&quot;</span>,    <span class='ident'>HTMLSourceElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;spacer&quot;</span>,    <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;span&quot;</span>,      <span class='ident'>HTMLSpanElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;strike&quot;</span>,    <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;strong&quot;</span>,    <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;style&quot;</span>,     <span class='ident'>HTMLStyleElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;sub&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;summary&quot;</span>,   <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;sup&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;table&quot;</span>,     <span class='ident'>HTMLTableElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;tbody&quot;</span>,     <span class='ident'>HTMLTableSectionElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;td&quot;</span>,        <span class='ident'>HTMLTableDataCellElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;template&quot;</span>,  <span class='ident'>HTMLTemplateElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;textarea&quot;</span>,  <span class='ident'>HTMLTextAreaElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;th&quot;</span>,        <span class='ident'>HTMLTableHeaderCellElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;time&quot;</span>,      <span class='ident'>HTMLTimeElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;title&quot;</span>,     <span class='ident'>HTMLTitleElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;tr&quot;</span>,        <span class='ident'>HTMLTableRowElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;tt&quot;</span>,        <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;track&quot;</span>,     <span class='ident'>HTMLTrackElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;u&quot;</span>,         <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;ul&quot;</span>,        <span class='ident'>HTMLUListElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;var&quot;</span>,       <span class='ident'>HTMLElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;video&quot;</span>,     <span class='ident'>HTMLVideoElement</span>);
    <span class='macro'>handle_element</span><span class='macro'>!</span>(<span class='ident'>document</span>, <span class='ident'>tag</span>, <span class='string'>&quot;wbr&quot;</span>,       <span class='ident'>HTMLElement</span>);

    <span class='kw'>return</span> <span class='ident'>ElementCast</span>::<span class='ident'>from_temporary</span>(<span class='ident'>HTMLUnknownElement</span>::<span class='ident'>new</span>(<span class='ident'>tag</span>, <span class='ident'>document</span>));
}

<span class='kw'>pub</span> <span class='kw'>fn</span> <span class='ident'>parse_html</span>(<span class='ident'>page</span>: <span class='kw-2'>&amp;</span><span class='ident'>Page</span>,
                  <span class='ident'>document</span>: <span class='kw-2'>&amp;</span><span class='ident'>JSRef</span><span class='op'>&lt;</span><span class='ident'>Document</span><span class='op'>&gt;</span>,
                  <span class='ident'>url</span>: <span class='ident'>Url</span>,
                  <span class='ident'>resource_task</span>: <span class='ident'>ResourceTask</span>)
                  <span class='op'>-&gt;</span> <span class='ident'>HtmlParserResult</span> {
    <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;Hubbub: parsing {:?}&quot;</span>, <span class='ident'>url</span>);<span class='comment'>
    // Spawn a CSS parser to receive links to CSS style sheets.

    </span><span class='kw'>let</span> (<span class='ident'>discovery_chan</span>, <span class='ident'>discovery_port</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
    <span class='kw'>let</span> <span class='ident'>stylesheet_chan</span> <span class='op'>=</span> <span class='ident'>discovery_chan</span>.<span class='ident'>clone</span>();
    <span class='kw'>let</span> (<span class='ident'>css_chan</span>, <span class='ident'>css_msg_port</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
    <span class='ident'>spawn_named</span>(<span class='string'>&quot;parse_html:css&quot;</span>, <span class='kw'>proc</span>() {
        <span class='ident'>css_link_listener</span>(<span class='ident'>stylesheet_chan</span>, <span class='ident'>css_msg_port</span>);
    });<span class='comment'>

    // Spawn a JS parser to receive JavaScript.
    </span><span class='kw'>let</span> <span class='ident'>resource_task2</span> <span class='op'>=</span> <span class='ident'>resource_task</span>.<span class='ident'>clone</span>();
    <span class='kw'>let</span> <span class='ident'>js_result_chan</span> <span class='op'>=</span> <span class='ident'>discovery_chan</span>.<span class='ident'>clone</span>();
    <span class='kw'>let</span> (<span class='ident'>js_chan</span>, <span class='ident'>js_msg_port</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
    <span class='ident'>spawn_named</span>(<span class='string'>&quot;parse_html:js&quot;</span>, <span class='kw'>proc</span>() {
        <span class='ident'>js_script_listener</span>(<span class='ident'>js_result_chan</span>, <span class='ident'>js_msg_port</span>, <span class='ident'>resource_task2</span>.<span class='ident'>clone</span>());
    });<span class='comment'>

    // Wait for the LoadResponse so that the parser knows the final URL.
    </span><span class='kw'>let</span> (<span class='ident'>input_chan</span>, <span class='ident'>input_port</span>) <span class='op'>=</span> <span class='ident'>channel</span>();
    <span class='ident'>resource_task</span>.<span class='ident'>send</span>(<span class='ident'>Load</span>(<span class='ident'>LoadData</span>::<span class='ident'>new</span>(<span class='ident'>url</span>.<span class='ident'>clone</span>()), <span class='ident'>input_chan</span>));
    <span class='kw'>let</span> <span class='ident'>load_response</span> <span class='op'>=</span> <span class='ident'>input_port</span>.<span class='ident'>recv</span>();

    <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;Fetched page; metadata is {:?}&quot;</span>, <span class='ident'>load_response</span>.<span class='ident'>metadata</span>);

    <span class='kw'>let</span> <span class='ident'>base_url</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='ident'>load_response</span>.<span class='ident'>metadata</span>.<span class='ident'>final_url</span>;

    {<span class='comment'>
        // Store the final URL before we start parsing, so that DOM routines
        // (e.g. HTMLImageElement::update_image) can resolve relative URLs
        // correctly.
        </span><span class='op'>*</span><span class='ident'>page</span>.<span class='ident'>mut_url</span>() <span class='op'>=</span> <span class='prelude-val'>Some</span>((<span class='ident'>base_url</span>.<span class='ident'>clone</span>(), <span class='boolval'>true</span>));
    }

    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>parser</span> <span class='op'>=</span> <span class='ident'>build_parser</span>(<span class='kw'>unsafe</span> { <span class='ident'>document</span>.<span class='ident'>to_hubbub_node</span>() });
    <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;created parser&quot;</span>);

    <span class='kw'>let</span> (<span class='ident'>css_chan2</span>, <span class='ident'>js_chan2</span>) <span class='op'>=</span> (<span class='ident'>css_chan</span>.<span class='ident'>clone</span>(), <span class='ident'>js_chan</span>.<span class='ident'>clone</span>());

    <span class='kw'>let</span> <span class='ident'>doc_cell</span> <span class='op'>=</span> <span class='ident'>RefCell</span>::<span class='ident'>new</span>(<span class='ident'>document</span>);

    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>tree_handler</span> <span class='op'>=</span> <span class='ident'>hubbub</span>::<span class='ident'>TreeHandler</span> {
        <span class='ident'>create_comment</span>: <span class='op'>|</span><span class='ident'>data</span>: <span class='ident'>String</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;create comment&quot;</span>);<span class='comment'>
            // NOTE: tmp vars are workaround for lifetime issues. Both required.
            </span><span class='kw'>let</span> <span class='ident'>tmp_borrow</span> <span class='op'>=</span> <span class='ident'>doc_cell</span>.<span class='ident'>borrow</span>();
            <span class='kw'>let</span> <span class='ident'>tmp</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>tmp_borrow</span>;
            <span class='kw'>let</span> <span class='ident'>comment</span> <span class='op'>=</span> <span class='ident'>Comment</span>::<span class='ident'>new</span>(<span class='ident'>data</span>, <span class='op'>*</span><span class='ident'>tmp</span>).<span class='ident'>root</span>();
            <span class='kw'>let</span> <span class='ident'>comment</span>: <span class='kw-2'>&amp;</span><span class='ident'>JSRef</span><span class='op'>&lt;</span><span class='ident'>Node</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>NodeCast</span>::<span class='ident'>from_ref</span>(<span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>comment</span>);
            <span class='kw'>unsafe</span> { <span class='ident'>comment</span>.<span class='ident'>to_hubbub_node</span>() }
        },
        <span class='ident'>create_doctype</span>: <span class='op'>|</span><span class='ident'>doctype</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>hubbub</span>::<span class='ident'>Doctype</span><span class='op'>&gt;</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;create doctype&quot;</span>);
            <span class='kw'>let</span> <span class='kw'>box</span> <span class='ident'>hubbub</span>::<span class='ident'>Doctype</span> {
                <span class='ident'>name</span>: <span class='ident'>name</span>,
                <span class='ident'>public_id</span>: <span class='ident'>public_id</span>,
                <span class='ident'>system_id</span>: <span class='ident'>system_id</span>,
                <span class='ident'>force_quirks</span>: _
            } <span class='op'>=</span> <span class='ident'>doctype</span>;<span class='comment'>
            // NOTE: tmp vars are workaround for lifetime issues. Both required.
            </span><span class='kw'>let</span> <span class='ident'>tmp_borrow</span> <span class='op'>=</span> <span class='ident'>doc_cell</span>.<span class='ident'>borrow</span>();
            <span class='kw'>let</span> <span class='ident'>tmp</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>tmp_borrow</span>;
            <span class='kw'>let</span> <span class='ident'>doctype_node</span> <span class='op'>=</span> <span class='ident'>DocumentType</span>::<span class='ident'>new</span>(<span class='ident'>name</span>, <span class='ident'>public_id</span>, <span class='ident'>system_id</span>, <span class='op'>*</span><span class='ident'>tmp</span>).<span class='ident'>root</span>();
            <span class='kw'>unsafe</span> {
                <span class='ident'>doctype_node</span>.<span class='ident'>deref</span>().<span class='ident'>to_hubbub_node</span>()
            }
        },
        <span class='ident'>create_element</span>: <span class='op'>|</span><span class='ident'>tag</span>: <span class='ident'>Box</span><span class='op'>&lt;</span><span class='ident'>hubbub</span>::<span class='ident'>Tag</span><span class='op'>&gt;</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;create element {}&quot;</span>, <span class='ident'>tag</span>.<span class='ident'>name</span>);<span class='comment'>
            // NOTE: tmp vars are workaround for lifetime issues. Both required.
            </span><span class='kw'>let</span> <span class='ident'>tmp_borrow</span> <span class='op'>=</span> <span class='ident'>doc_cell</span>.<span class='ident'>borrow</span>();
            <span class='kw'>let</span> <span class='ident'>tmp</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>tmp_borrow</span>;
            <span class='kw'>let</span> <span class='ident'>namespace</span> <span class='op'>=</span> <span class='kw'>match</span> <span class='ident'>tag</span>.<span class='ident'>ns</span> {
                <span class='ident'>HtmlNs</span> <span class='op'>=&gt;</span> <span class='ident'>namespace</span>::<span class='ident'>HTML</span>,
                <span class='ident'>MathMlNs</span> <span class='op'>=&gt;</span> <span class='ident'>namespace</span>::<span class='ident'>MathML</span>,
                <span class='ident'>SvgNs</span> <span class='op'>=&gt;</span> <span class='ident'>namespace</span>::<span class='ident'>SVG</span>,
                <span class='ident'>ns</span> <span class='op'>=&gt;</span> <span class='macro'>fail</span><span class='macro'>!</span>(<span class='string'>&quot;Not expecting namespace {:?}&quot;</span>, <span class='ident'>ns</span>),
            };
            <span class='kw'>let</span> <span class='ident'>element</span>: <span class='ident'>Root</span><span class='op'>&lt;</span><span class='ident'>Element</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>build_element_from_tag</span>(<span class='ident'>tag</span>.<span class='ident'>name</span>.<span class='ident'>clone</span>(), <span class='ident'>namespace</span>, <span class='op'>*</span><span class='ident'>tmp</span>).<span class='ident'>root</span>();

            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;-- attach attrs&quot;</span>);
            <span class='kw'>for</span> <span class='ident'>attr</span> <span class='kw'>in</span> <span class='ident'>tag</span>.<span class='ident'>attributes</span>.<span class='ident'>iter</span>() {
                <span class='kw'>let</span> (<span class='ident'>namespace</span>, <span class='ident'>prefix</span>) <span class='op'>=</span> <span class='kw'>match</span> <span class='ident'>attr</span>.<span class='ident'>ns</span> {
                    <span class='ident'>NullNs</span> <span class='op'>=&gt;</span> (<span class='ident'>namespace</span>::<span class='ident'>Null</span>, <span class='prelude-val'>None</span>),
                    <span class='ident'>XLinkNs</span> <span class='op'>=&gt;</span> (<span class='ident'>namespace</span>::<span class='ident'>XLink</span>, <span class='prelude-val'>Some</span>(<span class='string'>&quot;xlink&quot;</span>)),
                    <span class='ident'>XmlNs</span> <span class='op'>=&gt;</span> (<span class='ident'>namespace</span>::<span class='ident'>XML</span>, <span class='prelude-val'>Some</span>(<span class='string'>&quot;xml&quot;</span>)),
                    <span class='ident'>XmlNsNs</span> <span class='op'>=&gt;</span> (<span class='ident'>namespace</span>::<span class='ident'>XMLNS</span>, <span class='prelude-val'>Some</span>(<span class='string'>&quot;xmlns&quot;</span>)),
                    <span class='ident'>ns</span> <span class='op'>=&gt;</span> <span class='macro'>fail</span><span class='macro'>!</span>(<span class='string'>&quot;Not expecting namespace {:?}&quot;</span>, <span class='ident'>ns</span>),
                };
                <span class='ident'>element</span>.<span class='ident'>set_attribute_from_parser</span>(<span class='ident'>attr</span>.<span class='ident'>name</span>.<span class='ident'>clone</span>(),
                                                  <span class='ident'>attr</span>.<span class='ident'>value</span>.<span class='ident'>clone</span>(),
                                                  <span class='ident'>namespace</span>,
                                                  <span class='ident'>prefix</span>.<span class='ident'>map</span>(<span class='op'>|</span><span class='ident'>p</span><span class='op'>|</span> <span class='ident'>p</span>.<span class='ident'>to_string</span>()));
            }<span class='comment'>

            //FIXME: workaround for https://github.com/mozilla/rust/issues/13246;
            //       we get unrooting order failures if these are inside the match.
            </span><span class='kw'>let</span> <span class='ident'>rel</span> <span class='op'>=</span> {
                <span class='kw'>let</span> <span class='ident'>rel</span> <span class='op'>=</span> <span class='ident'>element</span>.<span class='ident'>deref</span>().<span class='ident'>get_attribute</span>(<span class='ident'>Null</span>, <span class='string'>&quot;rel&quot;</span>).<span class='ident'>root</span>();
                <span class='ident'>rel</span>.<span class='ident'>map</span>(<span class='op'>|</span><span class='ident'>a</span><span class='op'>|</span> <span class='ident'>a</span>.<span class='ident'>deref</span>().<span class='ident'>Value</span>())
            };
            <span class='kw'>let</span> <span class='ident'>href</span> <span class='op'>=</span> {
                <span class='kw'>let</span> <span class='ident'>href</span><span class='op'>=</span> <span class='ident'>element</span>.<span class='ident'>deref</span>().<span class='ident'>get_attribute</span>(<span class='ident'>Null</span>, <span class='string'>&quot;href&quot;</span>).<span class='ident'>root</span>();
                <span class='ident'>href</span>.<span class='ident'>map</span>(<span class='op'>|</span><span class='ident'>a</span><span class='op'>|</span> <span class='ident'>a</span>.<span class='ident'>deref</span>().<span class='ident'>Value</span>())
            };<span class='comment'>

            // Spawn additional parsing, network loads, etc. from tag and attrs
            </span><span class='kw'>let</span> <span class='ident'>type_id</span> <span class='op'>=</span> {
                <span class='kw'>let</span> <span class='ident'>node</span>: <span class='kw-2'>&amp;</span><span class='ident'>JSRef</span><span class='op'>&lt;</span><span class='ident'>Node</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>NodeCast</span>::<span class='ident'>from_ref</span>(<span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>element</span>);
                <span class='ident'>node</span>.<span class='ident'>type_id</span>()
            };
            <span class='kw'>match</span> <span class='ident'>type_id</span> {<span class='comment'>
                // Handle CSS style sheets from &lt;link&gt; elements
                </span><span class='ident'>ElementNodeTypeId</span>(<span class='ident'>HTMLLinkElementTypeId</span>) <span class='op'>=&gt;</span> {
                    <span class='kw'>match</span> (<span class='ident'>rel</span>, <span class='ident'>href</span>) {
                        (<span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='ident'>rel</span>), <span class='prelude-val'>Some</span>(<span class='kw-2'>ref</span> <span class='ident'>href</span>)) <span class='kw'>if</span> <span class='ident'>rel</span>.<span class='ident'>as_slice</span>().<span class='ident'>split</span>(<span class='ident'>HTML_SPACE_CHARACTERS</span>.<span class='ident'>as_slice</span>())
                                                              .<span class='ident'>any</span>(<span class='op'>|</span><span class='ident'>s</span><span class='op'>|</span> {
                                    <span class='ident'>s</span>.<span class='ident'>as_slice</span>().<span class='ident'>eq_ignore_ascii_case</span>(<span class='string'>&quot;stylesheet&quot;</span>)
                                }) <span class='op'>=&gt;</span> {
                            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;found CSS stylesheet: {:s}&quot;</span>, <span class='op'>*</span><span class='ident'>href</span>);
                            <span class='kw'>match</span> <span class='ident'>UrlParser</span>::<span class='ident'>new</span>().<span class='ident'>base_url</span>(<span class='ident'>base_url</span>).<span class='ident'>parse</span>(<span class='ident'>href</span>.<span class='ident'>as_slice</span>()) {
                                <span class='prelude-val'>Ok</span>(<span class='ident'>url</span>) <span class='op'>=&gt;</span> <span class='ident'>css_chan2</span>.<span class='ident'>send</span>(<span class='ident'>CSSTaskNewFile</span>(
                                    <span class='ident'>UrlProvenance</span>(<span class='ident'>url</span>, <span class='ident'>resource_task</span>.<span class='ident'>clone</span>()))),
                                <span class='prelude-val'>Err</span>(<span class='ident'>e</span>) <span class='op'>=&gt;</span> <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;Parsing url {:s} failed: {:s}&quot;</span>, <span class='op'>*</span><span class='ident'>href</span>, <span class='ident'>e</span>)
                            };
                        }
                        _ <span class='op'>=&gt;</span> {}
                    }
                }
                _ <span class='op'>=&gt;</span> {}
            }

            <span class='kw'>unsafe</span> { <span class='ident'>element</span>.<span class='ident'>deref</span>().<span class='ident'>to_hubbub_node</span>() }
        },
        <span class='ident'>create_text</span>: <span class='op'>|</span><span class='ident'>data</span>: <span class='ident'>String</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;create text&quot;</span>);<span class='comment'>
            // NOTE: tmp vars are workaround for lifetime issues. Both required.
            </span><span class='kw'>let</span> <span class='ident'>tmp_borrow</span> <span class='op'>=</span> <span class='ident'>doc_cell</span>.<span class='ident'>borrow</span>();
            <span class='kw'>let</span> <span class='ident'>tmp</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>tmp_borrow</span>;
            <span class='kw'>let</span> <span class='ident'>text</span> <span class='op'>=</span> <span class='ident'>Text</span>::<span class='ident'>new</span>(<span class='ident'>data</span>, <span class='op'>*</span><span class='ident'>tmp</span>).<span class='ident'>root</span>();
            <span class='kw'>unsafe</span> { <span class='ident'>text</span>.<span class='ident'>deref</span>().<span class='ident'>to_hubbub_node</span>() }
        },
        <span class='ident'>ref_node</span>: <span class='op'>|</span>_<span class='op'>|</span> {},
        <span class='ident'>unref_node</span>: <span class='op'>|</span>_<span class='op'>|</span> {},
        <span class='ident'>append_child</span>: <span class='op'>|</span><span class='ident'>parent</span>: <span class='ident'>hubbub</span>::<span class='ident'>NodeDataPtr</span>, <span class='ident'>child</span>: <span class='ident'>hubbub</span>::<span class='ident'>NodeDataPtr</span><span class='op'>|</span> {
            <span class='kw'>unsafe</span> {
                <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;append child {:x} {:x}&quot;</span>, <span class='ident'>parent</span>, <span class='ident'>child</span>);
                <span class='kw'>let</span> <span class='ident'>child</span>: <span class='ident'>Root</span><span class='op'>&lt;</span><span class='ident'>Node</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>from_hubbub_node</span>(<span class='ident'>child</span>).<span class='ident'>root</span>();
                <span class='kw'>let</span> <span class='ident'>parent</span>: <span class='ident'>Root</span><span class='op'>&lt;</span><span class='ident'>Node</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>from_hubbub_node</span>(<span class='ident'>parent</span>).<span class='ident'>root</span>();
                <span class='macro'>assert</span><span class='macro'>!</span>(<span class='ident'>parent</span>.<span class='ident'>deref</span>().<span class='ident'>AppendChild</span>(<span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>child</span>).<span class='ident'>is_ok</span>());
            }
            <span class='ident'>child</span>
        },
        <span class='ident'>insert_before</span>: <span class='op'>|</span><span class='ident'>_parent</span>, <span class='ident'>_child</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;insert before&quot;</span>);
            <span class='number'>0u</span>
        },
        <span class='ident'>remove_child</span>: <span class='op'>|</span><span class='ident'>_parent</span>, <span class='ident'>_child</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;remove child&quot;</span>);
            <span class='number'>0u</span>
        },
        <span class='ident'>clone_node</span>: <span class='op'>|</span><span class='ident'>_node</span>, <span class='ident'>deep</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;clone node&quot;</span>);
            <span class='kw'>if</span> <span class='ident'>deep</span> { <span class='macro'>error</span><span class='macro'>!</span>(<span class='string'>&quot;-- deep clone unimplemented&quot;</span>); }
            <span class='macro'>fail</span><span class='macro'>!</span>(<span class='string'>&quot;clone node unimplemented&quot;</span>)
        },
        <span class='ident'>reparent_children</span>: <span class='op'>|</span><span class='ident'>_node</span>, <span class='ident'>_new_parent</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;reparent children&quot;</span>);
            <span class='number'>0u</span>
        },
        <span class='ident'>get_parent</span>: <span class='op'>|</span><span class='ident'>_node</span>, <span class='ident'>_element_only</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;get parent&quot;</span>);
            <span class='number'>0u</span>
        },
        <span class='ident'>has_children</span>: <span class='op'>|</span><span class='ident'>_node</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;has children&quot;</span>);
            <span class='boolval'>false</span>
        },
        <span class='ident'>form_associate</span>: <span class='op'>|</span><span class='ident'>_form</span>, <span class='ident'>_node</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;form associate&quot;</span>);
        },
        <span class='ident'>add_attributes</span>: <span class='op'>|</span><span class='ident'>_node</span>, <span class='ident'>_attributes</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;add attributes&quot;</span>);
        },
        <span class='ident'>set_quirks_mode</span>: <span class='op'>|</span><span class='ident'>mode</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;set quirks mode&quot;</span>);<span class='comment'>
            // NOTE: tmp vars are workaround for lifetime issues. Both required.
            </span><span class='kw'>let</span> <span class='ident'>tmp_borrow</span> <span class='op'>=</span> <span class='ident'>doc_cell</span>.<span class='ident'>borrow_mut</span>();
            <span class='kw'>let</span> <span class='ident'>tmp</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>tmp_borrow</span>;
            <span class='ident'>tmp</span>.<span class='ident'>set_quirks_mode</span>(<span class='ident'>mode</span>);
        },
        <span class='ident'>encoding_change</span>: <span class='op'>|</span><span class='ident'>encname</span><span class='op'>|</span> {
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;encoding change&quot;</span>);<span class='comment'>
            // NOTE: tmp vars are workaround for lifetime issues. Both required.
            </span><span class='kw'>let</span> <span class='ident'>tmp_borrow</span> <span class='op'>=</span> <span class='ident'>doc_cell</span>.<span class='ident'>borrow_mut</span>();
            <span class='kw'>let</span> <span class='ident'>tmp</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>tmp_borrow</span>;
            <span class='ident'>tmp</span>.<span class='ident'>set_encoding_name</span>(<span class='ident'>encname</span>);
        },
        <span class='ident'>complete_script</span>: <span class='op'>|</span><span class='ident'>script</span><span class='op'>|</span> {
            <span class='kw'>unsafe</span> {
                <span class='kw'>let</span> <span class='ident'>script</span>: <span class='kw-2'>&amp;</span><span class='ident'>JSRef</span><span class='op'>&lt;</span><span class='ident'>Element</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='op'>*</span><span class='ident'>from_hubbub_node</span>(<span class='ident'>script</span>).<span class='ident'>root</span>();
                <span class='kw'>match</span> <span class='ident'>script</span>.<span class='ident'>get_attribute</span>(<span class='ident'>Null</span>, <span class='string'>&quot;src&quot;</span>).<span class='ident'>root</span>() {
                    <span class='prelude-val'>Some</span>(<span class='ident'>src</span>) <span class='op'>=&gt;</span> {
                        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;found script: {:s}&quot;</span>, <span class='ident'>src</span>.<span class='ident'>deref</span>().<span class='ident'>Value</span>());
                        <span class='kw'>match</span> <span class='ident'>UrlParser</span>::<span class='ident'>new</span>().<span class='ident'>base_url</span>(<span class='ident'>base_url</span>)
                                .<span class='ident'>parse</span>(<span class='ident'>src</span>.<span class='ident'>deref</span>().<span class='ident'>value</span>().<span class='ident'>as_slice</span>()) {
                            <span class='prelude-val'>Ok</span>(<span class='ident'>new_url</span>) <span class='op'>=&gt;</span> <span class='ident'>js_chan2</span>.<span class='ident'>send</span>(<span class='ident'>JSTaskNewFile</span>(<span class='ident'>new_url</span>)),
                            <span class='prelude-val'>Err</span>(<span class='ident'>e</span>) <span class='op'>=&gt;</span> <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;Parsing url {:s} failed: {:s}&quot;</span>, <span class='ident'>src</span>.<span class='ident'>deref</span>().<span class='ident'>Value</span>(), <span class='ident'>e</span>)
                        };
                    }
                    <span class='prelude-val'>None</span> <span class='op'>=&gt;</span> {
                        <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>data</span> <span class='op'>=</span> <span class='ident'>String</span>::<span class='ident'>new</span>();
                        <span class='kw'>let</span> <span class='ident'>scriptnode</span>: <span class='kw-2'>&amp;</span><span class='ident'>JSRef</span><span class='op'>&lt;</span><span class='ident'>Node</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>NodeCast</span>::<span class='ident'>from_ref</span>(<span class='ident'>script</span>);
                        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;iterating over children {:?}&quot;</span>, <span class='ident'>scriptnode</span>.<span class='ident'>first_child</span>());
                        <span class='kw'>for</span> <span class='ident'>child</span> <span class='kw'>in</span> <span class='ident'>scriptnode</span>.<span class='ident'>children</span>() {
                            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;child = {:?}&quot;</span>, <span class='ident'>child</span>);
                            <span class='kw'>let</span> <span class='ident'>text</span>: <span class='kw-2'>&amp;</span><span class='ident'>JSRef</span><span class='op'>&lt;</span><span class='ident'>Text</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>TextCast</span>::<span class='ident'>to_ref</span>(<span class='kw-2'>&amp;</span><span class='ident'>child</span>).<span class='ident'>unwrap</span>();
                            <span class='ident'>data</span>.<span class='ident'>push_str</span>(<span class='ident'>text</span>.<span class='ident'>deref</span>().<span class='ident'>characterdata</span>.<span class='ident'>data</span>.<span class='ident'>deref</span>().<span class='ident'>borrow</span>().<span class='ident'>as_slice</span>());
                        }

                        <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;script data = {:?}&quot;</span>, <span class='ident'>data</span>);
                        <span class='ident'>js_chan2</span>.<span class='ident'>send</span>(<span class='ident'>JSTaskNewInlineScript</span>(<span class='ident'>data</span>, <span class='ident'>base_url</span>.<span class='ident'>clone</span>()));
                    }
                }
            }
            <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;complete script&quot;</span>);
        },
        <span class='ident'>complete_style</span>: <span class='op'>|</span>_<span class='op'>|</span> {<span class='comment'>
            // style parsing is handled in element::notify_child_list_changed.
        </span>},
    };
    <span class='ident'>parser</span>.<span class='ident'>set_tree_handler</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>tree_handler</span>);
    <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;set tree handler&quot;</span>);

    <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;loaded page&quot;</span>);
    <span class='kw'>loop</span> {
        <span class='kw'>match</span> <span class='ident'>load_response</span>.<span class='ident'>progress_port</span>.<span class='ident'>recv</span>() {
            <span class='ident'>Payload</span>(<span class='ident'>data</span>) <span class='op'>=&gt;</span> {
                <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;received data&quot;</span>);
                <span class='ident'>parser</span>.<span class='ident'>parse_chunk</span>(<span class='ident'>data</span>.<span class='ident'>as_slice</span>());
            }
            <span class='ident'>Done</span>(<span class='prelude-val'>Err</span>(<span class='ident'>err</span>)) <span class='op'>=&gt;</span> {
                <span class='macro'>fail</span><span class='macro'>!</span>(<span class='string'>&quot;Failed to load page URL {:s}, error: {:s}&quot;</span>, <span class='ident'>url</span>.<span class='ident'>serialize</span>(), <span class='ident'>err</span>);
            }
            <span class='ident'>Done</span>(..) <span class='op'>=&gt;</span> {
                <span class='kw'>break</span>;
            }
        }
    }

    <span class='macro'>debug</span><span class='macro'>!</span>(<span class='string'>&quot;finished parsing&quot;</span>);
    <span class='ident'>css_chan</span>.<span class='ident'>send</span>(<span class='ident'>CSSTaskExit</span>);
    <span class='ident'>js_chan</span>.<span class='ident'>send</span>(<span class='ident'>JSTaskExit</span>);

    <span class='ident'>HtmlParserResult</span> {
        <span class='ident'>discovery_port</span>: <span class='ident'>discovery_port</span>,
    }
}

<span class='kw'>fn</span> <span class='ident'>build_parser</span>(<span class='ident'>node</span>: <span class='ident'>hubbub</span>::<span class='ident'>NodeDataPtr</span>) <span class='op'>-&gt;</span> <span class='ident'>hubbub</span>::<span class='ident'>Parser</span> {
    <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>parser</span> <span class='op'>=</span> <span class='ident'>hubbub</span>::<span class='ident'>Parser</span>(<span class='string'>&quot;UTF-8&quot;</span>, <span class='boolval'>false</span>);
    <span class='ident'>parser</span>.<span class='ident'>set_document_node</span>(<span class='ident'>node</span>);
    <span class='ident'>parser</span>.<span class='ident'>enable_scripting</span>(<span class='boolval'>true</span>);
    <span class='ident'>parser</span>.<span class='ident'>enable_styling</span>(<span class='boolval'>true</span>);
    <span class='ident'>parser</span>
}

</pre>
</section>
    <section id='search' class="content hidden"></section>

    <section class="footer"></section>

    <div id="help" class="hidden">
        <div class="shortcuts">
            <h1>Keyboard shortcuts</h1>
            <dl>
                <dt>?</dt>
                <dd>Show this help dialog</dd>
                <dt>S</dt>
                <dd>Focus the search field</dd>
                <dt>&uarr;</dt>
                <dd>Move up in search results</dd>
                <dt>&darr;</dt>
                <dd>Move down in search results</dd>
                <dt>&#9166;</dt>
                <dd>Go to active search result</dd>
            </dl>
        </div>
        <div class="infos">
            <h1>Search tricks</h1>
            <p>
                Prefix searches with a type followed by a colon (e.g.
                <code>fn:</code>) to restrict the search to a given type.
            </p>
            <p>
                Accepted types are: <code>fn</code>, <code>mod</code>,
                <code>struct</code> (or <code>str</code>), <code>enum</code>,
                <code>trait</code>, <code>typedef</code> (or
                <code>tdef</code>).
            </p>
        </div>
    </div>

    <script>
        window.rootPath = "../../../../../../../../../../../";
        window.currentCrate = "script";
        window.playgroundUrl = "";
    </script>
    <script src="../../../../../../../../../../../jquery.js"></script>
    <script src="../../../../../../../../../../../main.js"></script>
    
    <script async src="../../../../../../../../../../../search-index.js"></script>
</body>
</html>